<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualização de Fine-tunings</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  <style>
    :root {
      --primary-color: #3b82f6;
      --primary-hover: #2563eb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --red-100: #fee2e2;
      --red-500: #ef4444;
      --red-700: #b91c1c;
      --yellow-100: #fef3c7;
      --yellow-500: #f59e0b;
      --yellow-700: #b45309;
      --green-100: #d1fae5;
      --green-500: #10b981;
      --green-700: #047857;
      --blue-100: #dbeafe;
      --blue-500: #3b82f6;
      --blue-700: #1d4ed8;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.5;
      color: var(--gray-800);
      background-color: #f9fafb;
      padding: 1rem;
    }
    
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      font-size: 1.875rem;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    
    h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 1rem;
    }
    
    h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 0.75rem;
    }
    
    p {
      margin-bottom: 1rem;
    }
    
    .card {
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .file-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      border: 2px dashed var(--gray-300);
      border-radius: 0.5rem;
      background-color: var(--gray-100);
      margin-bottom: 1.5rem;
    }
    
    .file-upload p {
      margin-bottom: 1rem;
      text-align: center;
      color: var(--gray-700);
    }
    
    .file-upload input[type="file"] {
      display: none;
    }
    
    .btn {
      display: inline-block;
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
      text-align: center;
    }
    
    .btn:hover {
      background-color: var(--primary-hover);
    }
    
    .btn-secondary {
      background-color: white;
      color: var(--gray-800);
      border: 1px solid var(--gray-300);
    }
    
    .btn-secondary:hover {
      background-color: var(--gray-100);
    }
    
    .hidden {
      display: none !important;
    }
    
    .alert {
      padding: 1rem;
      border-radius: 0.375rem;
      margin-bottom: 1rem;
    }
    
    .alert-danger {
      background-color: var(--red-100);
      border: 1px solid var(--red-500);
      color: var(--red-700);
    }
    
    .alert-warning {
      background-color: var(--yellow-100);
      border: 1px solid var(--yellow-500);
      color: var(--yellow-700);
    }
    
    .alert-success {
      background-color: var(--green-100);
      border: 1px solid var(--green-500);
      color: var(--green-700);
    }
    
    .alert-info {
      background-color: var(--blue-100);
      border: 1px solid var(--blue-500);
      color: var(--blue-700);
    }
    
    .run-card {
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      border: 1px solid var(--gray-200);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .run-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .run-card h3 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }
    
    .params-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .param-item {
      display: flex;
      flex-direction: column;
    }
    
    .param-label {
      font-size: 0.875rem;
      color: var(--gray-500);
    }
    
    .param-value {
      font-family: monospace;
      font-size: 0.9375rem;
    }
    
    .chart-container {
      height: 400px;
      position: relative;
      margin-bottom: 1rem;
    }
    
    .qa-item {
      border: 1px solid var(--gray-200);
      border-radius: 0.375rem;
      overflow: hidden;
      margin-bottom: 0.75rem;
    }
    
    .qa-question {
      padding: 1rem;
      background-color: var(--gray-100);
      font-weight: 500;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .qa-answer {
      padding: 1rem;
      border-top: 1px solid var(--gray-200);
      display: none;
    }
    
    .qa-answer.open {
      display: block;
    }
    
    .qa-answer ol, .qa-answer ul {
      padding-left: 2rem;
      margin: 1rem 0;
    }
    
    .qa-answer li {
      margin-bottom: 0.5rem;
    }
    
    .qa-answer ol {
      list-style-position: outside;
    }
    
    .qa-answer blockquote {
      border-left: 4px solid var(--gray-300);
      padding-left: 1rem;
      margin-left: 0;
      color: var(--gray-700);
    }
    
    .qa-answer pre {
      background-color: var(--gray-100);
      padding: 0.75rem;
      border-radius: 0.375rem;
      overflow-x: auto;
      margin: 1rem 0;
    }
    
    .qa-answer code {
      font-family: monospace;
      background-color: var(--gray-100);
      padding: 0.2rem 0.4rem;
      border-radius: 0.25rem;
      font-size: 0.875em;
    }
    
    .qa-answer pre code {
      background-color: transparent;
      padding: 0;
    }
    
    .qa-answer a {
      color: var(--primary-color);
      text-decoration: none;
    }
    
    .qa-answer a:hover {
      text-decoration: underline;
    }
    
    textarea.form-control {
      min-height: 100px;
      font-family: monospace;
      resize: vertical;
      border: 1px solid var(--gray-300);
      background-color: #fff;
    }
    
    .comparison-dropdown {
      position: absolute;
      top: 1rem;
      right: 1rem;
      z-index: 10;
    }
    
    .comparison-view {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .comparison-panel {
      width: 100%;
    }
    
    .comparison-header {
      background-color: var(--gray-100);
      padding: 0.75rem;
      border-radius: 0.375rem;
      margin-bottom: 1rem;
      text-align: center;
      font-weight: 600;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    
    .modal-content {
      background-color: white;
      margin: 2% auto;
      padding: 20px;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 1000px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.375rem;
      font-size: 1rem;
    }
    
    .btn-group {
      display: flex;
      justify-content: space-between;
      margin-top: 1rem;
    }
    
    .flex {
      display: flex;
    }
    
    .justify-between {
      justify-content: space-between;
    }
    
    .items-center {
      align-items: center;
    }
    
    .mb-4 {
      margin-bottom: 1rem;
    }
    
    .text-center {
      text-align: center;
    }
    
    .mt-4 {
      margin-top: 1rem;
    }
    
    @media (max-width: 768px) {
      .comparison-view {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 640px) {
      .params-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Visualização de Fine-tunings</h1>
    
    <div id="file-upload" class="card">
      <div class="file-upload">
        <p>Carregue seu arquivo <code>runs.json</code> para visualizar os treinamentos</p>
        <label for="json-file" class="btn">Escolher Arquivo</label>
        <input type="file" id="json-file" accept=".json">
      </div>
      <div id="file-info" class="hidden alert alert-info"></div>
    </div>
    
    <div id="error-container" class="hidden"></div>
    
    <div id="run-selector" class="hidden card">
      <div class="flex justify-between items-center mb-4">
        <h2>Selecione um Treinamento</h2>
        <div id="download-container" class="hidden">
          <button id="download-runs-btn" class="btn">Fazer Download do Arquivo</button>
        </div>
      </div>
      <div id="run-list"></div>
      <div class="text-center mt-4">
        <button id="add-run-btn" class="btn">Adicionar Novo Fine-tuning</button>
      </div>
    </div>
    
    <div id="run-details" class="hidden">
      <button id="back-button" class="btn">← Voltar para Lista</button>
      
      <div id="single-view">
        <div class="card relative">
          <div class="comparison-dropdown">
            <select id="comparison-select" class="btn btn-secondary">
              <option value="">Comparar com...</option>
            </select>
          </div>
          <h2 id="run-title"></h2>
          <div id="parameters" class="params-grid"></div>
        </div>
        
        <div class="card">
          <h3>Curvas de Perda</h3>
          <div class="chart-container">
            <canvas id="loss-chart"></canvas>
          </div>
        </div>
        
        <div class="card">
          <h3>Perguntas e Respostas</h3>
          <div id="qa-list"></div>
          <div class="mt-4">
            <button id="add-qa-to-run-btn" class="btn">Adicionar Nova Pergunta e Resposta</button>
          </div>
        </div>
      </div>
      
      <div id="comparison-view" class="hidden">
        <div class="comparison-view">
          <!-- Left panel (original run) -->
          <div class="comparison-panel">
            <div class="comparison-header" id="original-run-header"></div>
            <div class="card">
              <h2 id="original-run-title"></h2>
              <div id="original-parameters" class="params-grid"></div>
            </div>
            
            <div class="card">
              <h3>Curvas de Perda</h3>
              <div class="chart-container">
                <canvas id="original-loss-chart"></canvas>
              </div>
            </div>
            
            <div class="card">
              <h3>Perguntas e Respostas</h3>
              <div id="original-qa-list"></div>
            </div>
          </div>
          
          <!-- Right panel (comparison run) -->
          <div class="comparison-panel">
            <div class="comparison-header" id="comparison-run-header"></div>
            <div class="card">
              <h2 id="comparison-run-title"></h2>
              <div id="comparison-parameters" class="params-grid"></div>
            </div>
            
            <div class="card">
              <h3>Curvas de Perda</h3>
              <div class="chart-container">
                <canvas id="comparison-loss-chart"></canvas>
              </div>
            </div>
            
            <div class="card">
              <h3>Perguntas e Respostas</h3>
              <div id="comparison-qa-list"></div>
            </div>
          </div>
        </div>
        
        <button id="exit-comparison-button" class="btn">Sair da Comparação</button>
      </div>
    </div>
  </div>

  <div id="add-run-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Adicionar Novo Fine-tuning</h2>
      
      <form id="add-run-form">
        <div class="form-group">
          <label for="run-name">Nome do Fine-tuning:</label>
          <input type="text" id="run-name" class="form-control" placeholder="ex: gemma-4b-run1" required>
        </div>
        
        <h3>Parâmetros</h3>
        <div class="params-grid">
          <div class="form-group">
            <label for="param-epochs">epochs:</label>
            <input type="text" id="param-epochs" class="form-control" value="3">
          </div>
          <div class="form-group">
            <label for="param-learning-rate">learning_rate:</label>
            <input type="text" id="param-learning-rate" class="form-control" value="2e-4">
          </div>
          <div class="form-group">
            <label for="param-batch-size">batch_size:</label>
            <input type="text" id="param-batch-size" class="form-control" value="2">
          </div>
          <div class="form-group">
            <label for="param-lora-rank">lora_rank:</label>
            <input type="text" id="param-lora-rank" class="form-control" value="8">
          </div>
          <div class="form-group">
            <label for="param-lora-alpha">lora_alpha:</label>
            <input type="text" id="param-lora-alpha" class="form-control" value="8">
          </div>
          <div class="form-group">
            <label for="param-lora-dropout">lora_dropout:</label>
            <input type="text" id="param-lora-dropout" class="form-control" value="0.05">
          </div>
          <div class="form-group">
            <label for="param-max-seq-length">max_seq_length:</label>
            <input type="text" id="param-max-seq-length" class="form-control" value="2048">
          </div>
          <div class="form-group">
            <label for="param-lr-scheduler">lr_scheduler_type:</label>
            <input type="text" id="param-lr-scheduler" class="form-control" value="linear">
          </div>
        </div>
        
        <div class="form-group">
          <label for="training-logs">Perdas de Treinamento e Avaliação (cole todo o log):</label>
          <textarea id="training-logs" class="form-control" rows="15" placeholder="{'loss': 0.2817, 'grad_norm': 1.4229, 'learning_rate': 7.16e-06, 'epoch': 2.61}
{'eval_loss': 0.4215, 'eval_runtime': 36.46, 'eval_samples_per_second': 3.23, 'epoch': 2.64}"></textarea>
        </div>
        
        <div class="btn-group">
          <button type="button" id="cancel-add-run" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn">Salvar Fine-tuning</button>
        </div>
      </form>
    </div>
  </div>

  <div id="add-qa-modal" class="modal">
    <div class="modal-content">
      <span class="close" id="close-qa-modal">&times;</span>
      <h2>Adicionar Nova Pergunta e Resposta</h2>
      
      <form id="add-qa-form">
        <div class="form-group">
          <label for="new-question">Pergunta:</label>
          <input type="text" id="new-question" class="form-control" placeholder="Digite a pergunta aqui" required>
        </div>
        
        <div class="form-group">
          <label for="new-answer">Resposta (formato markdown):</label>
          <textarea id="new-answer" class="form-control" rows="10" placeholder="Digite a resposta aqui usando formatação markdown" required></textarea>
        </div>
        
        <div class="btn-group">
          <button type="button" id="cancel-add-qa" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Global variables
      let chart = null;
      let originalChart = null;
      let comparisonChart = null;
      let trainingData = null;
      let originalTrainingData = null;
      let currentRunIndex = null;
      let originalFilename = null;
      
      // DOM Elements
      const fileInput = document.getElementById('json-file');
      const fileInfo = document.getElementById('file-info');
      const errorContainer = document.getElementById('error-container');
      const runSelector = document.getElementById('run-selector');
      const runList = document.getElementById('run-list');
      const runDetails = document.getElementById('run-details');
      const runTitle = document.getElementById('run-title');
      const parameters = document.getElementById('parameters');
      const qaList = document.getElementById('qa-list');
      const backButton = document.getElementById('back-button');
      const singleView = document.getElementById('single-view');
      const comparisonView = document.getElementById('comparison-view');
      const comparisonSelect = document.getElementById('comparison-select');
      const exitComparisonButton = document.getElementById('exit-comparison-button');
      const addRunBtn = document.getElementById('add-run-btn');
      const addRunModal = document.getElementById('add-run-modal');
      const closeModal = document.querySelector('.close');
      const cancelAddRun = document.getElementById('cancel-add-run');
      const addRunForm = document.getElementById('add-run-form');
      const addQaToRunBtn = document.getElementById('add-qa-to-run-btn');
      const addQaModal = document.getElementById('add-qa-modal');
      const closeQaModal = document.getElementById('close-qa-modal');
      const cancelAddQa = document.getElementById('cancel-add-qa');
      const addQaForm = document.getElementById('add-qa-form');
      const downloadRunsBtn = document.getElementById('download-runs-btn');
      
      // Event Listeners
      fileInput.addEventListener('change', handleFileSelect);
      backButton.addEventListener('click', showRunSelector);
      comparisonSelect.addEventListener('change', handleComparisonSelect);
      exitComparisonButton.addEventListener('click', exitComparisonView);
      addRunBtn.addEventListener('click', openAddRunModal);
      closeModal.addEventListener('click', closeAddRunModal);
      cancelAddRun.addEventListener('click', closeAddRunModal);
      addRunForm.addEventListener('submit', handleAddRunSubmit);
      addQaToRunBtn.addEventListener('click', openAddQaModal);
      closeQaModal.addEventListener('click', closeAddQaModal);
      cancelAddQa.addEventListener('click', closeAddQaModal);
      addQaForm.addEventListener('submit', handleAddQaSubmit);
      downloadRunsBtn.addEventListener('click', downloadRunsFile);
      
      // Format parameter display - just return value as-is since we're using strings
      function formatParameterValue(key, value) {
        return value;
      }
      
      // Handle file selection
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Store original filename
        originalFilename = file.name;
        
        fileInfo.textContent = `Arquivo selecionado: ${file.name}`;
        fileInfo.classList.remove('hidden');
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
          try {
            trainingData = JSON.parse(e.target.result);
            
            // Store original data for comparison
            originalTrainingData = JSON.parse(e.target.result);
            
            // Clear any previous errors
            errorContainer.classList.add('hidden');
            errorContainer.innerHTML = '';
            
            // Hide the file upload section
            document.getElementById('file-upload').classList.add('hidden');
            
            // Display the list of runs
            displayRunList(trainingData);
          } catch (error) {
            showError(`Falha ao processar arquivo JSON: ${error.message}`);
          }
        };
        
        reader.onerror = function() {
          showError('Erro ao ler arquivo');
        };
        
        reader.readAsText(file);
      }
      
      // Display error message
      function showError(message) {
        errorContainer.innerHTML = `
          <div class="alert alert-danger">
            ${message}
          </div>
        `;
        errorContainer.classList.remove('hidden');
        runSelector.classList.add('hidden');
      }
      
      // Show a success message
      function showMessage(message, type = 'info') {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-info';
        
        errorContainer.innerHTML = `
          <div class="alert ${alertClass}">
            ${message}
          </div>
        `;
        errorContainer.classList.remove('hidden');
        
        // Auto-hide after a few seconds
        setTimeout(() => {
          errorContainer.classList.add('hidden');
        }, 5000);
      }
      
      // Check if data has been modified and show download button if needed
      function checkForDataChanges() {
        const downloadContainer = document.getElementById('download-container');
        
        // If we don't have original data, we can't compare
        if (!originalTrainingData || !trainingData) {
          downloadContainer.classList.add('hidden');
          return;
        }
        
        // Check if data has changed
        const originalJson = JSON.stringify(originalTrainingData);
        const currentJson = JSON.stringify(trainingData);
        
        if (originalJson !== currentJson) {
          // Data has changed, show download button
          downloadContainer.classList.remove('hidden');
        } else {
          // No changes, hide download button
          downloadContainer.classList.add('hidden');
        }
      }
      
      // Download the current runs file
      function downloadRunsFile() {
        if (!trainingData || !originalFilename) return;
        
        try {
          const jsonStr = JSON.stringify(trainingData, null, 2);
          const blob = new Blob([jsonStr], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = originalFilename; // Use original filename
          a.click();
          
          URL.revokeObjectURL(url);
          
          // Update original data to match current data
          originalTrainingData = JSON.parse(JSON.stringify(trainingData));
          
          // Update UI
          checkForDataChanges();
          
          showMessage(`Arquivo ${originalFilename} salvo com sucesso.`, 'success');
        } catch (error) {
          showError(`Erro ao salvar arquivo: ${error.message}`);
        }
      }
      
      // Display the list of runs
      function displayRunList(runs) {
        if (!Array.isArray(runs) || runs.length === 0) {
          showError('Nenhum treinamento encontrado no arquivo ou formato inválido');
          return;
        }
        
        runList.innerHTML = '';
        
        runs.forEach((run, index) => {
          if (!run.run_model || !run.parameters) {
            return; // Skip invalid run data
          }
          
          const runItem = document.createElement('div');
          runItem.className = 'run-card';
          
          let paramsHTML = '';
          if (run.parameters) {
            const keysToShow = ['learning_rate', 'batch_size', 'lora_rank', 'epochs'].filter(key => 
              run.parameters.hasOwnProperty(key)
            );
            
            if (keysToShow.length > 0) {
              paramsHTML = `
                <div class="run-params">
                  ${keysToShow.map(key => `
                    <span class="param-badge">${key}: <code>${formatParameterValue(key, run.parameters[key])}</code></span>
                  `).join(' ')}
                </div>
              `;
            }
          }
          
          runItem.innerHTML = `
            <h3>${run.run_model}</h3>
            ${paramsHTML}
          `;
          
          runItem.addEventListener('click', () => displayRunDetails(run, index));
          runList.appendChild(runItem);
        });
        
        runSelector.classList.remove('hidden');
        
        // Check if download button should be shown
        checkForDataChanges();
      }
      
      // Show run selector
      function showRunSelector() {
        runDetails.classList.add('hidden');
        runSelector.classList.remove('hidden');
        
        // Keep download button current
        checkForDataChanges();
      }
      
      // Display the details of a selected run
      function displayRunDetails(run, index) {
        runSelector.classList.add('hidden');
        runDetails.classList.remove('hidden');
        
        // Store current run index
        currentRunIndex = index;
        
        // Reset comparison view
        singleView.classList.remove('hidden');
        comparisonView.classList.add('hidden');
        
        // Set run title
        runTitle.textContent = run.run_model;
        
        // Populate comparison dropdown
        populateComparisonDropdown(index);
        
        // Display parameters
        displayParameters(run.parameters, parameters);
        
        // Display loss chart
        if (run.train_losses && run.eval_losses) {
          displayLossChart(run.train_losses, run.eval_losses, 'loss-chart');
        } else {
          document.querySelector('.chart-container').innerHTML = `
            <div class="alert alert-warning">Nenhum dado de perda disponível para este treinamento</div>
          `;
        }
        
        // Display Q&A pairs
        displayQAPairs(run.qa, qaList);
      }
      
      // Populate comparison dropdown
      function populateComparisonDropdown(excludeIndex) {
        comparisonSelect.innerHTML = '<option value="">Comparar com...</option>';
        
        if (!trainingData || !Array.isArray(trainingData)) return;
        
        trainingData.forEach((run, index) => {
          if (index !== excludeIndex && run.run_model) {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = run.run_model;
            comparisonSelect.appendChild(option);
          }
        });
      }
      
      // Handle comparison selection
      function handleComparisonSelect(event) {
        const comparisonIndex = parseInt(event.target.value);
        
        if (isNaN(comparisonIndex) || comparisonIndex === '') {
          return;
        }
        
        const originalRun = trainingData[currentRunIndex];
        const comparisonRun = trainingData[comparisonIndex];
        
        if (!originalRun || !comparisonRun) {
          return;
        }
        
        // Switch to comparison view
        singleView.classList.add('hidden');
        comparisonView.classList.remove('hidden');
        
        // Set headers
        document.getElementById('original-run-header').textContent = originalRun.run_model;
        document.getElementById('comparison-run-header').textContent = comparisonRun.run_model;
        
        // Set titles
        document.getElementById('original-run-title').textContent = originalRun.run_model;
        document.getElementById('comparison-run-title').textContent = comparisonRun.run_model;
        
        // Display parameters
        displayParameters(originalRun.parameters, document.getElementById('original-parameters'));
        displayParameters(comparisonRun.parameters, document.getElementById('comparison-parameters'));
        
        // Display loss charts
        if (originalRun.train_losses && originalRun.eval_losses) {
          displayLossChart(originalRun.train_losses, originalRun.eval_losses, 'original-loss-chart');
        }
        
        if (comparisonRun.train_losses && comparisonRun.eval_losses) {
          displayLossChart(comparisonRun.train_losses, comparisonRun.eval_losses, 'comparison-loss-chart');
        }
        
        // Display Q&A pairs
        displayQAPairs(originalRun.qa, document.getElementById('original-qa-list'));
        displayQAPairs(comparisonRun.qa, document.getElementById('comparison-qa-list'));
      }
      
      // Exit comparison view
      function exitComparisonView() {
        singleView.classList.remove('hidden');
        comparisonView.classList.add('hidden');
        comparisonSelect.value = '';
      }
      
      // Display parameters
      function displayParameters(params, targetElement) {
        if (!params) {
          targetElement.innerHTML = '<div class="alert alert-warning">Nenhum parâmetro disponível</div>';
          return;
        }
        
        targetElement.innerHTML = '';
        
        Object.entries(params).forEach(([key, value]) => {
          const paramItem = document.createElement('div');
          paramItem.className = 'param-item';
          paramItem.innerHTML = `
            <span class="param-label">${key}</span>
            <span class="param-value">${formatParameterValue(key, value)}</span>
          `;
          targetElement.appendChild(paramItem);
        });
      }
      
      // Display the loss chart
      function displayLossChart(trainLosses, evalLosses, chartId) {
        const ctx = document.getElementById(chartId).getContext('2d');
        
        // Get the right chart variable to update
        let chartInstance;
        if (chartId === 'loss-chart') {
          if (chart) chart.destroy();
          chartInstance = chart;
        } else if (chartId === 'original-loss-chart') {
          if (originalChart) originalChart.destroy();
          chartInstance = originalChart;
        } else if (chartId === 'comparison-loss-chart') {
          if (comparisonChart) comparisonChart.destroy();
          chartInstance = comparisonChart;
        }
        
        // Convert the loss data to the format expected by Chart.js
        const trainData = trainLosses.map(item => ({
          x: item[1],  // epoch
          y: item[0]   // loss
        }));
        
        const evalData = evalLosses.map(item => ({
          x: item[1],  // epoch
          y: item[0]   // loss
        }));
        
        // Create the chart
        const newChart = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [
              {
                label: 'Perda de Treinamento',
                data: trainData,
                borderColor: 'rgb(59, 130, 246)', // blue-500
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.1,
                pointRadius: 0,
                borderWidth: 2
              },
              {
                label: 'Perda de Avaliação',
                data: evalData,
                borderColor: 'rgb(239, 68, 68)', // red-500
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.1,
                pointRadius: 3,
                borderWidth: 2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              x: {
                type: 'linear',
                title: {
                  display: true,
                  text: 'Época'
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Perda'
                },
                beginAtZero: false
              }
            },
            plugins: {
              tooltip: {
                enabled: true
              },
              legend: {
                position: 'top'
              },
              title: {
                display: true,
                text: 'Curvas de Perda de Treinamento e Avaliação'
              }
            }
          }
        });
        
        // Update the appropriate chart reference
        if (chartId === 'loss-chart') {
          chart = newChart;
        } else if (chartId === 'original-loss-chart') {
          originalChart = newChart;
        } else if (chartId === 'comparison-loss-chart') {
          comparisonChart = newChart;
        }
        
        return newChart;
      }
      
      // Display Q&A pairs
      function displayQAPairs(qaPairs, targetElement) {
        targetElement.innerHTML = '';
        
        if (!qaPairs || qaPairs.length === 0) {
          targetElement.innerHTML = '<div class="alert alert-warning">Nenhuma pergunta e resposta disponível</div>';
          return;
        }
        
        qaPairs.forEach((qa, index) => {
          if (!qa.q || !qa.a) return;
          
          const qaItem = document.createElement('div');
          qaItem.className = 'qa-item';
          
          const question = document.createElement('div');
          question.className = 'qa-question';
          question.innerHTML = `
            <span>${qa.q}</span>
            <span class="toggle-icon">+</span>
          `;
          
          const answer = document.createElement('div');
          answer.className = 'qa-answer';
          
          // Use marked.js to render markdown
          answer.innerHTML = marked.parse(qa.a);
          
          qaItem.appendChild(question);
          qaItem.appendChild(answer);
          
          question.addEventListener('click', () => {
            const isOpen = answer.classList.contains('open');
            
            // Toggle the answer visibility
            if (isOpen) {
              answer.classList.remove('open');
              question.querySelector('.toggle-icon').textContent = '+';
            } else {
              answer.classList.add('open');
              question.querySelector('.toggle-icon').textContent = '−';
            }
          });
          
          targetElement.appendChild(qaItem);
        });
      }
      
      // Open modal to add new run
      function openAddRunModal() {
        addRunModal.style.display = 'block';
      }
      
      // Close the run modal
      function closeAddRunModal() {
        addRunModal.style.display = 'none';
      }
      
      // Open modal to add new QA pair
      function openAddQaModal() {
        // Reset form
        document.getElementById('new-question').value = '';
        document.getElementById('new-answer').value = '';
        
        // Show modal
        addQaModal.style.display = 'block';
      }
      
      // Close QA modal
      function closeAddQaModal() {
        addQaModal.style.display = 'none';
      }
      
      // Handle the form submission to add a new run
      function handleAddRunSubmit(event) {
        event.preventDefault();
        
        try {
          // Gather form data
          const runName = document.getElementById('run-name').value;
          
          // Get parameters as strings
          const parameters = {
            epochs: document.getElementById('param-epochs').value,
            learning_rate: document.getElementById('param-learning-rate').value,
            batch_size: document.getElementById('param-batch-size').value,
            lora_rank: document.getElementById('param-lora-rank').value,
            lora_alpha: document.getElementById('param-lora-alpha').value,
            lora_dropout: document.getElementById('param-lora-dropout').value,
            max_seq_length: document.getElementById('param-max-seq-length').value,
            lr_scheduler_type: document.getElementById('param-lr-scheduler').value
          };
          
          // Parse losses from combined logs
          const combinedLogs = document.getElementById('training-logs').value;
          const { trainLosses, evalLosses } = parseCombinedLogs(combinedLogs);
          
          // Create the new run object with empty QA array
          const newRun = {
            run_model: runName,
            parameters: parameters,
            train_losses: trainLosses,
            eval_losses: evalLosses,
            qa: []
          };
          
          // Add to existing data
          if (!trainingData) {
            trainingData = [];
          }
          
          trainingData.push(newRun);
          
          // Check for changes and update UI
          checkForDataChanges();
          
          // Close modal and reset form
          closeAddRunModal();
          addRunForm.reset();
          
          // Update the run list display
          displayRunList(trainingData);
          
          // Show success message
          showMessage('Fine-tuning adicionado com sucesso!', 'success');
        } catch (error) {
          showError(`Erro ao adicionar fine-tuning: ${error.message}`);
        }
      }
      
      // Handle adding a new QA pair to current run
      function handleAddQaSubmit(event) {
        event.preventDefault();
        
        if (!trainingData || currentRunIndex === null) {
          showError('Nenhum fine-tuning selecionado para adicionar perguntas');
          return;
        }
        
        const question = document.getElementById('new-question').value.trim();
        const answer = document.getElementById('new-answer').value.trim();
        
        if (!question || !answer) {
          showError('Por favor, preencha a pergunta e a resposta');
          return;
        }
        
        // Create new QA pair
        const newQA = {
          q: question,
          a: answer
        };
        
        // Add to current run
        if (!trainingData[currentRunIndex].qa) {
          trainingData[currentRunIndex].qa = [];
        }
        
        trainingData[currentRunIndex].qa.push(newQA);
        
        // Update the display
        displayQAPairs(trainingData[currentRunIndex].qa, qaList);
        
        // Check for changes and update UI
        checkForDataChanges();
        
        // Close modal
        closeAddQaModal();
        
        // Show success message
        showMessage('Pergunta e resposta adicionadas com sucesso!', 'success');
      }
      
      // Parse combined logs for training and evaluation losses
      function parseCombinedLogs(text) {
        const lines = text.trim().split('\n');
        const trainLosses = [];
        const evalLosses = [];
        
        // Process each line
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          try {
            // Check if this line or next line contains loss data
            const currentLine = line;
            const nextLine = i + 1 < lines.length ? lines[i + 1] : '';
            
            // Get the line with the actual data (could be current or next)
            const dataLine = currentLine.includes('{') ? currentLine : 
                            nextLine.includes('{') ? nextLine : '';
            
            if (dataLine) {
              // Check for training loss
              if (dataLine.includes('loss":') || dataLine.includes("loss':") || 
                  dataLine.includes('loss":') || dataLine.includes("loss':")) {
                  
                // Extract loss - support both 'loss' and "loss" formats
                const lossMatch = dataLine.match(/['"]loss['"]:\s*([\d.]+)/);
                const epochMatch = dataLine.match(/['"]epoch['"]:\s*([\d.]+)/);
                
                if (lossMatch && epochMatch && !dataLine.includes('eval_loss')) {
                  const loss = parseFloat(lossMatch[1]);
                  const epoch = parseFloat(epochMatch[1]);
                  
                  if (!isNaN(loss) && !isNaN(epoch)) {
                    trainLosses.push([loss, epoch]);
                    // Skip next line if we used it
                    if (dataLine === nextLine) i++;
                  }
                }
              }
              
              // Check for eval loss
              if (dataLine.includes('eval_loss":') || dataLine.includes("eval_loss':") ||
                  dataLine.includes('eval_loss":') || dataLine.includes("eval_loss':")) {
                  
                // Extract eval_loss - support both formats
                const evalLossMatch = dataLine.match(/['"]eval_loss['"]:\s*([\d.]+)/);
                const epochMatch = dataLine.match(/['"]epoch['"]:\s*([\d.]+)/);
                
                if (evalLossMatch && epochMatch) {
                  const evalLoss = parseFloat(evalLossMatch[1]);
                  const epoch = parseFloat(epochMatch[1]);
                  
                  if (!isNaN(evalLoss) && !isNaN(epoch)) {
                    evalLosses.push([evalLoss, epoch]);
                    // Skip next line if we used it
                    if (dataLine === nextLine) i++;
                  }
                }
              }
            }
          } catch (e) {
            // Skip invalid lines
            console.warn('Linha inválida ignorada:', line, e);
          }
        }
        
        // Sort both arrays by epoch
        trainLosses.sort((a, b) => a[1] - b[1]);
        evalLosses.sort((a, b) => a[1] - b[1]);
        
        return { trainLosses, evalLosses };
      }
    });
  </script>
</body>
</html>